<div class="settings-container">
    <div class="page-header">
        <button mat-icon-button (click)="goBack()">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <h2>Settings</h2>
    </div>

    <div class="settings-content">
        <!-- Push Notifications Section -->
        <div class="section">
            <div class="section-header">Push Notifications</div>

            @if (permissionState() === 'granted') {
            <div class="status-row granted">
                <mat-icon>check_circle</mat-icon>
                <span>Notifications enabled</span>
            </div>
            @if (!thisDeviceRegistered()) {
            <button mat-stroked-button (click)="enableNotifications()" [disabled]="loading()">
                <mat-icon>add</mat-icon>
                Register This Device
            </button>
            }
            } @else if (permissionState() === 'denied') {
            <div class="status-row denied">
                <mat-icon>block</mat-icon>
                <span>Notifications blocked. Enable in browser settings.</span>
            </div>
            } @else {
            <button mat-flat-button color="primary" (click)="enableNotifications()" [disabled]="loading()">
                <mat-icon>notifications_active</mat-icon>
                Enable Notifications
            </button>
            }
        </div>

        <!-- Test Notification -->
        @if (thisDeviceRegistered()) {
        <div class="section">
            <div class="section-header">Test</div>
            <div class="test-row">
                <button mat-stroked-button (click)="sendTestNotification()" [disabled]="testSending()">
                    <mat-icon>send</mat-icon>
                    Send Test Notification
                </button>
                @if (testResult() === 'sent') {
                <span class="test-result sent">Sent!</span>
                } @else if (testResult() === 'error') {
                <span class="test-result error">Failed to send</span>
                }
            </div>
        </div>
        }

        <!-- Registered Devices -->
        @if (subscriptions().length > 0) {
        <div class="section">
            <div class="section-header">Registered Devices</div>
            <mat-list>
                @for (sub of subscriptions(); track sub.id) {
                <mat-list-item>
                    <mat-icon matListItemIcon>devices</mat-icon>
                    <span matListItemTitle>{{ getDeviceLabel(sub.userAgent) }}</span>
                    <span matListItemLine class="device-date">{{ sub.createdAt | date:'MMM d, y' }}</span>
                    <button mat-icon-button matListItemMeta (click)="removeDevice(sub)" matTooltip="Remove">
                        <mat-icon>delete</mat-icon>
                    </button>
                </mat-list-item>
                }
            </mat-list>
        </div>
        }
    </div>
</div>
