<div class="settings-container">
    <div class="page-header">
        <button mat-icon-button (click)="goBack()">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <h2>
            <mat-icon>settings</mat-icon>
            Settings
        </h2>
    </div>

    <div class="cards-wrapper">

        <!-- Push Notifications & Devices -->
        <div class="card-row">
            <mat-accordion>
                <mat-expansion-panel expanded>
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            <span class="card-title">Push Notifications</span>
                        </mat-panel-title>
                        <mat-panel-description>
                            @if (permissionState() === 'granted' && thisDeviceRegistered()) {
                            <span class="status-chip granted">Enabled</span>
                            } @else if (permissionState() === 'denied') {
                            <span class="status-chip denied">Blocked</span>
                            } @else {
                            <span class="status-chip default">Not enabled</span>
                            }
                        </mat-panel-description>
                    </mat-expansion-panel-header>

                    <div class="panel-section">
                        @if (permissionState() === 'granted') {
                        <div class="status-row granted">
                            <mat-icon>check_circle</mat-icon>
                            <span>Notifications enabled</span>
                        </div>
                        @if (!thisDeviceRegistered()) {
                        <button mat-stroked-button class="action-btn" (click)="enableNotifications()" [disabled]="loading()">
                            <mat-icon>add</mat-icon>
                            Register This Device
                        </button>
                        }

                        @if (thisDeviceRegistered()) {
                        <div class="test-row">
                            <button mat-stroked-button class="action-btn" (click)="sendTestNotification()" [disabled]="testSending()">
                                <mat-icon>send</mat-icon>
                                Send Test
                            </button>
                            @if (testResult() === 'sent') {
                            <span class="test-result sent">Sent!</span>
                            } @else if (testResult() === 'error') {
                            <span class="test-result error">Failed</span>
                            }
                        </div>
                        }
                        } @else if (permissionState() === 'denied') {
                        <div class="status-row denied">
                            <mat-icon>block</mat-icon>
                            <span>Notifications blocked. Enable in browser settings.</span>
                        </div>
                        } @else {
                        <button mat-flat-button color="primary" class="action-btn" (click)="enableNotifications()" [disabled]="loading()">
                            <mat-icon>notifications_active</mat-icon>
                            Enable Notifications
                        </button>
                        }
                    </div>

                    @if (subscriptions().length > 0) {
                    <div class="panel-section">
                        <div class="section-label">Registered Devices</div>
                        @for (sub of subscriptions(); track sub.id) {
                        <div class="list-row">
                            <mat-icon class="list-row-icon">devices</mat-icon>
                            <div class="list-row-text">
                                <span class="list-row-title">{{ getDeviceLabel(sub.userAgent) }}</span>
                                <span class="list-row-sub">{{ sub.createdAt | date:'MMM d, y' }}</span>
                            </div>
                            <button mat-icon-button (click)="removeDevice(sub)" matTooltip="Remove device">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        }
                    </div>
                    }
                </mat-expansion-panel>
            </mat-accordion>
        </div>

        <!-- Active Sessions -->
        <div class="card-row">
            <mat-accordion>
                <mat-expansion-panel expanded>
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            <span class="card-title">Active Sessions</span>
                        </mat-panel-title>
                        <mat-panel-description>
                            {{ sessions().length }} session{{ sessions().length === 1 ? '' : 's' }}
                        </mat-panel-description>
                    </mat-expansion-panel-header>

                    @if (sessions().length > 0) {
                    <div class="panel-section">
                        @for (session of sessions(); track session.id) {
                        <div class="list-row">
                            <mat-icon class="list-row-icon">devices</mat-icon>
                            <div class="list-row-text">
                                <span class="list-row-title">
                                    {{ getDeviceLabel(session.userAgent ?? undefined) }}
                                    @if (isCurrentSession(session)) {
                                        <span class="current-session-badge">This device</span>
                                    }
                                </span>
                                <span class="list-row-sub">
                                    Signed in {{ session.createdAt | date:'MMM d, y' }}
                                    · Expires {{ session.expiresAt | date:'MMM d, y' }}
                                </span>
                            </div>
                            @if (!isCurrentSession(session)) {
                            <button mat-icon-button (click)="revokeSession(session.id)" matTooltip="Revoke session">
                                <mat-icon>delete</mat-icon>
                            </button>
                            }
                        </div>
                        }
                    </div>
                    } @else {
                    <div class="empty-state">No active sessions.</div>
                    }
                </mat-expansion-panel>
            </mat-accordion>
        </div>

        <!-- Permissions -->
        <div class="card-row">
            <mat-accordion>
                <mat-expansion-panel>
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            <span class="card-title">Permissions</span>
                        </mat-panel-title>
                        <mat-panel-description>
                            {{ myPermissionCount() }} of {{ totalPermissions() }}
                        </mat-panel-description>
                    </mat-expansion-panel-header>

                    <div class="panel-section">
                        <app-permission-grid [permissions]="allPermissions()" [(selectedIds)]="myPermissionIds" [disabled]="true" [tooltips]="permissionTooltips()" />
                    </div>
                </mat-expansion-panel>
            </mat-accordion>
        </div>

        <!-- API Keys -->
        <div class="card-row">
            <mat-accordion>
                <mat-expansion-panel expanded>
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            <span class="card-title">API Keys</span>
                        </mat-panel-title>
                        <mat-panel-description>
                            {{ apiKeys().length }} key{{ apiKeys().length === 1 ? '' : 's' }}
                        </mat-panel-description>
                    </mat-expansion-panel-header>

                    <div class="panel-section">
                        <button mat-flat-button color="primary" class="action-btn" (click)="openCreateKeyDialog()">
                            <mat-icon>add</mat-icon>
                            Generate New Key
                        </button>
                    </div>

                    @if (apiKeys().length > 0) {
                    <div class="panel-section">
                        @for (key of apiKeys(); track key.id) {
                        <div class="list-row">
                            <mat-icon class="list-row-icon" [class.expired-icon]="isExpired(key)">vpn_key</mat-icon>
                            <div class="list-row-text">
                                <span class="list-row-title" [class.expired-text]="isExpired(key)">{{ key.name }}</span>
                                <span class="list-row-sub">
                                    Created {{ key.createdAt | date:'MMM d, y' }}
                                    @if (key.lastUsedAt) {
                                        · Last used {{ key.lastUsedAt | date:'MMM d, y' }}
                                    }
                                    @if (key.permissions) {
                                        · {{ key.permissions.length }} of {{ totalPermissions() }} permissions
                                    }
                                    @if (key.expiresAt) {
                                        @if (isExpired(key)) {
                                            · <span class="expired-badge">Expired</span>
                                        } @else {
                                            · Expires {{ key.expiresAt | date:'MMM d, y' }}
                                        }
                                    } @else {
                                        · Never expires
                                    }
                                </span>
                            </div>
                            <button mat-icon-button (click)="revokeApiKey(key.id)" matTooltip="Revoke API key">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        }
                    </div>
                    } @else {
                    <div class="empty-state">No API keys yet.</div>
                    }
                </mat-expansion-panel>
            </mat-accordion>
        </div>

    </div>
</div>
