<div class="order-view-container">
  <div class="header">
    <button mat-icon-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h2>
      @if (isEditMode()) {
      Order #{{ orderID() }}
      } @else {
      New Order
      }
    </h2>
    <span class="spacer"></span>
    @if (isEditMode() && !isFormEditMode() && !isReceiveMode()) {
    @if (canReceive()) {
    <button mat-flat-button color="accent" (click)="enterReceiveMode()">
      <mat-icon>inventory_2</mat-icon>
      Receive
    </button>
    } @else if (hasNextStatus()) {
    <button mat-flat-button color="accent" (click)="moveToNextStatus()">
      <mat-icon>arrow_forward</mat-icon>
      Mark as {{ nextStatusName() }}
    </button>
    }
    <button mat-button (click)="enableEdit()">
      <mat-icon>edit</mat-icon>
      Edit
    </button>
    }
    @if (isReceiveMode()) {
    <button mat-button (click)="cancelReceiveMode()">
      <mat-icon>close</mat-icon>
      Cancel
    </button>
    <button mat-flat-button color="primary" (click)="completeReceipt()">
      <mat-icon>check</mat-icon>
      Complete Receipt
    </button>
    }
    @if (isFormEditMode() || !isEditMode()) {
    @if (isFormEditMode()) {
    <button mat-button (click)="cancelEdit()">
      <mat-icon>close</mat-icon>
      Cancel
    </button>
    <button mat-flat-button class="mat-custom-error" (click)="delete()">
      <mat-icon>delete</mat-icon>
      Delete
    </button>
    }
    <button mat-flat-button color="primary" (click)="save()">
      <mat-icon>save</mat-icon>
      Save
    </button>
    }
  </div>

  <div class="content-wrapper">
    <mat-card class="order-info-card">
      <mat-card-header>
        <mat-card-title>Order Information</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (isFormEditMode() || !isEditMode()) {
        <form [formGroup]="form" class="order-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea matInput formControlName="description" rows="4" placeholder="Order description"></textarea>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Vendor</mat-label>
            <input matInput formControlName="vendor" placeholder="Vendor name">
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Tracking Number</mat-label>
              <input matInput formControlName="trackingNumber" placeholder="Tracking number">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Link</mat-label>
              <input matInput formControlName="link" placeholder="Order or tracking link">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Placed Date</mat-label>
              <input matInput [matDatepicker]="placedPicker" formControlName="placedDate" required>
              <mat-datepicker-toggle matIconSuffix [for]="placedPicker"></mat-datepicker-toggle>
              <mat-datepicker #placedPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Received Date</mat-label>
              <input matInput [matDatepicker]="receivedPicker" formControlName="receivedDate">
              <mat-datepicker-toggle matIconSuffix [for]="receivedPicker"></mat-datepicker-toggle>
              <mat-datepicker #receivedPicker></mat-datepicker>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Order Status</mat-label>
            <mat-select formControlName="orderStatusID" required>
              @for (status of orderStatuses(); track status.id) {
              <mat-option [value]="status.id">{{ status.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Notes</mat-label>
            <textarea matInput formControlName="notes" rows="4"
              placeholder="Internal notes about this order"></textarea>
          </mat-form-field>
        </form>
        } @else {
        <div class="order-view-info">
          <div class="info-item">
            <div class="info-label">Description</div>
            <div class="info-value description-text">{{ currentOrder()?.description || '-' }}</div>
          </div>

          <div class="info-item">
            <div class="info-label">Vendor</div>
            <div class="info-value">{{ currentOrder()?.vendor || '-' }}</div>
          </div>

          <div class="info-row">
            <div class="info-item">
              <div class="info-label">Tracking Number</div>
              <div class="info-value">{{ currentOrder()?.trackingNumber || '-' }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Link</div>
              <div class="info-value">
                @if (currentOrder()?.link) {
                <a [href]="currentOrder()!.link" target="_blank" rel="noopener noreferrer">
                  {{ currentOrder()!.link }}
                </a>
                } @else {
                -
                }
              </div>
            </div>
          </div>

          <div class="info-row">
            <div class="info-item">
              <div class="info-label">Placed Date</div>
              <div class="info-value">{{ formatDate(currentOrder()?.placedDate || null) }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Received Date</div>
              <div class="info-value">{{ formatDate(currentOrder()?.receivedDate || null) }}</div>
            </div>
          </div>

          <div class="info-item">
            <div class="info-label">Order Status</div>
            <div class="info-value">
              <span class="status-badge" [style.background-color]="currentOrder()?.OrderStatus?.tagColor || '#cccccc'"
                [style.color]="getContrastColor(currentOrder()?.OrderStatus?.tagColor || '#cccccc')">
                {{ currentOrder()?.OrderStatus?.name || 'Unknown' }}
              </span>
            </div>
          </div>

          <div class="info-item">
            <div class="info-label">Notes</div>
            <div class="info-value description-text">{{ currentOrder()?.notes || '-' }}</div>
          </div>
        </div>
        }
      </mat-card-content>
    </mat-card>

    @if (isEditMode() && orderId()) {
    <mat-card class="line-items-card">
      <mat-card-header>
        <mat-card-title>Line Items</mat-card-title>
        @if (isFormEditMode()) {
        <button mat-flat-button color="primary" (click)="addLineItem()">
          <mat-icon>add</mat-icon>
          Add Line Item
        </button>
        }
      </mat-card-header>
      <mat-card-content>
        <div class="table-wrapper">
          <table mat-table [dataSource]="orderItems()" class="line-items-table" cdkDropList
            [cdkDropListDisabled]="!isFormEditMode()" (cdkDropListDropped)="dropLineItem($event)">
            <!-- Drag Handle Column -->
            <ng-container matColumnDef="dragHandle">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let item">
                @if (isFormEditMode()) {
                <mat-icon class="drag-handle" cdkDragHandle>drag_indicator</mat-icon>
                }
              </td>
            </ng-container>

            <!-- Line Number Column -->
            <ng-container matColumnDef="lineNumber">
              <th mat-header-cell *matHeaderCellDef>#</th>
              <td mat-cell *matCellDef="let item">
                {{ item.lineNumber }}
              </td>
            </ng-container>

            <!-- Line Type Column -->
            <ng-container matColumnDef="lineType">
              <th mat-header-cell *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let item">
                @if (isFormEditMode() && editingItemId() === item.id) {
                <mat-form-field appearance="outline" class="inline-edit-field">
                  <mat-select [ngModel]="editingLineTypeId()" (ngModelChange)="editingLineTypeId.set($event)">
                    @for (type of orderLineTypes(); track type.id) {
                    <mat-option [value]="type.id">{{ type.name }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
                } @else {
                {{ item.OrderLineType?.name || '-' }}
                }
              </td>
            </ng-container>

            <!-- Part Column -->
            <ng-container matColumnDef="part">
              <th mat-header-cell *matHeaderCellDef>Part / Description</th>
              <td mat-cell *matCellDef="let item">
                @if (isFormEditMode() && editingItemId() === item.id) {
                @if (isPartOrEquipmentTypeId(editingLineTypeId())) {
                <mat-form-field appearance="outline" class="inline-edit-field part-selector">
                  <mat-label>Select Part</mat-label>
                  <mat-select [ngModel]="editingPartId()" (ngModelChange)="editingPartId.set($event)">
                    @for (part of parts(); track part.id) {
                    <mat-option [value]="part.id">
                      {{ part.name }}
                      @if (part.sku) {
                      <span class="part-option-sku"> ({{ part.sku }})</span>
                      }
                    </mat-option>
                    }
                  </mat-select>
                </mat-form-field>
                } @else {
                <mat-form-field appearance="outline" class="inline-edit-field">
                  <mat-label>Description</mat-label>
                  <input matInput [ngModel]="editingDescription()" (ngModelChange)="editingDescription.set($event)"
                    placeholder="Line item description">
                </mat-form-field>
                }
                } @else {
                @if (item.Part) {
                <div class="part-info">
                  <div class="part-name-wrapper" #wrapper
                    (mouseenter)="tooltipStyle = {'top': wrapper.getBoundingClientRect().top - 8 + 'px', 'left': wrapper.getBoundingClientRect().left + 'px'}"
                    >
                    <a [routerLink]="['/parts', item.Part.id, 'edit']" class="part-link">{{ item.Part.name }}</a>
                    @if (item.Part.imageFile?.data) {
                    <div class="part-image-tooltip" [ngStyle]="tooltipStyle">
                      <img [src]="item.Part.imageFile.data" [alt]="item.Part.name">
                    </div>
                    }
                  </div>
                  <div class="part-subtitle">{{ item.Part.description }}</div>
                  @if (item.Part.vendor) {
                  <div class="part-subtitle">SKU: {{ item.Part.sku }} | Vendor: {{ item.Part.vendor }}</div>
                  }
                </div>
                } @else {
                {{ item.name || '-' }}
                }
                }
              </td>
            </ng-container>

            <!-- Barcode Column -->
            <ng-container matColumnDef="barcode">
              <th mat-header-cell *matHeaderCellDef>Barcode</th>
              <td mat-cell *matCellDef="let item">
                @if (isEquipmentPart(item) && item.Equipment?.length) {
                @for (equipment of item.Equipment; track equipment.id) {
                <app-barcode-tag [barcode]="equipment.Barcode?.barcode"></app-barcode-tag>
                }
                } @else if (item.Traces?.length) {
                @for (trace of item.Traces; track trace.id) {
                <app-barcode-tag [barcode]="trace.Barcode?.barcode || trace.barcode"></app-barcode-tag>
                }
                } @else {
                -
                }
              </td>
            </ng-container>

            <!-- Quantity Column -->
            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Qty</th>
              <td mat-cell *matCellDef="let item">
                @if (isFormEditMode() && editingItemId() === item.id) {
                <mat-form-field appearance="outline" class="inline-edit-field">
                  <input matInput type="number" [ngModel]="editingQuantity()" (ngModelChange)="onQuantityChange($event)"
                    min="1">
                </mat-form-field>
                } @else {
                @if (isReceivableLineType(item)) {
                {{ item.quantity }}
                } @else {
                -
                }
                }
              </td>
            </ng-container>

            <!-- Ordered Column (for receive mode) -->
            <ng-container matColumnDef="ordered">
              <th mat-header-cell *matHeaderCellDef>Ordered</th>
              <td mat-cell *matCellDef="let item">
                @if (isReceivableLineType(item)) {
                {{ item.quantity }}
                } @else {
                -
                }
              </td>
            </ng-container>

            <!-- Received Column -->
            <ng-container matColumnDef="received">
              <th mat-header-cell *matHeaderCellDef>Received</th>
              <td mat-cell *matCellDef="let item">
                @if (isReceivableLineType(item)) {
                {{ item.receivedQuantity || 0 }}
                } @else {
                -
                }
              </td>
            </ng-container>

            <!-- Remaining Column (for receive mode) -->
            <ng-container matColumnDef="remaining">
              <th mat-header-cell *matHeaderCellDef>Remaining</th>
              <td mat-cell *matCellDef="let item">
                @if (getRemainingQuantity(item) > 0) {
                <span class="remaining-qty">{{ getRemainingQuantity(item) }}</span>
                } @else {
                <span class="fully-received">
                  <mat-icon>check_circle</mat-icon>
                  Complete
                </span>
                }
              </td>
            </ng-container>

            <!-- Price Column -->
            <ng-container matColumnDef="price">
              <th mat-header-cell *matHeaderCellDef>Price</th>
              <td mat-cell *matCellDef="let item">
                @if (isFormEditMode() && editingItemId() === item.id) {
                <mat-form-field appearance="outline" class="inline-edit-field">
                  <input matInput type="number" [ngModel]="editingPrice()" (ngModelChange)="onPriceChange($event)"
                    step="0.00001" min="0">
                </mat-form-field>
                } @else {
                ${{ formatPrice(item) }}
                }
              </td>
            </ng-container>

            <!-- Total Column -->
            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let item">
                @if (isFormEditMode() && editingItemId() === item.id) {
                <strong>${{ (editingQuantity() * editingPrice()).toFixed(2) }}</strong>
                } @else {
                <strong>${{ calculateLineTotal(item).toFixed(2) }}</strong>
                }
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let item">
                @if (isFormEditMode()) {
                @if (editingItemId() === item.id) {
                <button mat-icon-button color="primary" (click)="saveLineItem(item)" matTooltip="Save">
                  <mat-icon>check</mat-icon>
                </button>
                <button mat-icon-button (click)="cancelLineItemEdit()" matTooltip="Cancel">
                  <mat-icon>close</mat-icon>
                </button>
                } @else {
                <button mat-icon-button (click)="editLineItem(item)" matTooltip="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteLineItem(item)" matTooltip="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
                }
                } @else if (isReceiveMode() && isReceivableLineType(item)) {
                @if (getRemainingQuantity(item) > 0) {
                <button mat-icon-button color="primary" (click)="receiveLineItem(item)" matTooltip="Receive">
                  <mat-icon>inventory_2</mat-icon>
                </button>
                } @else {
                <mat-icon class="received-check">check_circle</mat-icon>
                }
                }
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" cdkDrag [cdkDragDisabled]="!isFormEditMode()">
            </tr>

            <!-- No data row -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" [attr.colspan]="displayedColumns.length">
                <div class="no-data">
                  <mat-icon>inventory_2</mat-icon>
                  <p>No line items added yet</p>
                </div>
              </td>
            </tr>
          </table>
        </div>

        @if (orderItems().length > 0) {
        <div class="order-total">
          <strong>Order Total: ${{ calculateOrderTotal().toFixed(2) }}</strong>
        </div>
        }
      </mat-card-content>
    </mat-card>
    }
  </div>
</div>