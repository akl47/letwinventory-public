<div class="property-panel">
  <!-- Metadata section - always visible -->
  <mat-expansion-panel [expanded]="true" class="metadata-panel">
    <mat-expansion-panel-header>
      <mat-panel-title>Harness Info</mat-panel-title>
    </mat-expansion-panel-header>

    <div class="property-group">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Name</mat-label>
        <input matInput [value]="harnessData()?.name || ''" (input)="updateMetadata('name', $event)" [disabled]="isLocked()">
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Part Number</mat-label>
        <input matInput [value]="harnessData()?.partNumber || ''" disabled>
      </mat-form-field>

      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Revision</mat-label>
        <input matInput [value]="harnessData()?.revision || 'A'" disabled>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description</mat-label>
        <textarea matInput rows="2" [value]="harnessData()?.description || ''"
          (input)="updateMetadata('description', $event)" [disabled]="isLocked()"></textarea>
      </mat-form-field>

      <div class="harness-actions">
        <button mat-stroked-button color="warn" (click)="deleteHarness.emit()" [disabled]="isLocked()">
          <mat-icon>delete</mat-icon>
          Delete Harness
        </button>
      </div>
    </div>
  </mat-expansion-panel>

  <!-- Release Status Panel -->
  <mat-expansion-panel [expanded]="true" class="release-panel">
    <mat-expansion-panel-header>
      <mat-panel-title>Release Status</mat-panel-title>
      <mat-panel-description>
        @if (isReleased()) {
          <span class="status-chip released">Released</span>
        } @else if (isInReview()) {
          <span class="status-chip review">In Review</span>
        } @else {
          <span class="status-chip draft">Draft</span>
        }
      </mat-panel-description>
    </mat-expansion-panel-header>

    <div class="release-actions">
      @if (isReleased()) {
        <span [matTooltip]="isViewOnly() ? 'You do not have permission' : ''">
          <button mat-flat-button color="primary" (click)="newRevision.emit()" [disabled]="isViewOnly()">
            <mat-icon>add_circle</mat-icon>
            New Revision
          </button>
        </span>
      } @else if (isInReview()) {
        <span [matTooltip]="isViewOnly() ? 'You do not have permission' : ''">
          <button mat-flat-button color="primary" (click)="releaseHarness.emit()" [disabled]="isViewOnly()">
            <mat-icon>publish</mat-icon>
            Release
          </button>
        </span>
        <span [matTooltip]="isViewOnly() ? 'You do not have permission' : ''">
          <button mat-stroked-button (click)="returnToDraft.emit()" [disabled]="isViewOnly()">
            <mat-icon>undo</mat-icon>
            Return to Draft
          </button>
        </span>
      } @else {
        <span [matTooltip]="isViewOnly() ? 'You do not have permission' : ''">
          <button mat-flat-button color="primary" (click)="releaseHarness.emit()" [disabled]="isViewOnly()">
            <mat-icon>send</mat-icon>
            To Review
          </button>
        </span>
      }
    </div>
  </mat-expansion-panel>

  <!-- Bulk Wire Edit Panel - shows when multiple wires selected (not in locked mode) -->
  @if (hasMultipleWiresSelected() && !isLocked()) {
  <mat-expansion-panel [expanded]="true" class="bulk-wire-panel">
    <mat-expansion-panel-header>
      <mat-panel-title>Bulk Wire Edit ({{ selectedWireIds().length }} wires)</mat-panel-title>
    </mat-expansion-panel-header>

    <div class="property-group">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Wire Color</mat-label>
        <mat-select [value]="selectedWiresCommonValues()?.color || ''"
          (selectionChange)="updateBulkWires('color', $event.value)">
          <mat-option value="">Mixed / No change</mat-option>
          @for (color of wireColors; track color.code) {
          <mat-option [value]="color.code">
            <span class="color-option">
              <span class="color-swatch" [style.backgroundColor]="color.hex"></span>
              {{ color.name }} ({{ color.code }})
            </span>
          </mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Wire Gauge</mat-label>
        <mat-select [value]="selectedWiresCommonValues()?.gauge || ''"
          (selectionChange)="updateBulkWires('gauge', $event.value)">
          <mat-option value="">Mixed / No change</mat-option>
          @for (gauge of awgGauges; track gauge) {
          <mat-option [value]="gauge">{{ gauge }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Length (mm)</mat-label>
        <input matInput type="number" [value]="selectedWiresCommonValues()?.lengthMm || ''"
          (input)="updateBulkWiresInput('lengthMm', $event)"
          placeholder="Leave empty to keep individual values" min="1">
      </mat-form-field>

      <mat-divider></mat-divider>

      <!-- Wire End Terminations -->
      <div class="termination-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Left End</mat-label>
          <mat-select [value]="selectedWiresCommonValues()?.fromTermination || ''"
            (selectionChange)="updateBulkWires('fromTermination', $event.value)">
            <mat-option value="">Mixed / No change</mat-option>
            @for (term of terminationTypes(); track term.value) {
            <mat-option [value]="term.value">{{ term.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Right End</mat-label>
          <mat-select [value]="selectedWiresCommonValues()?.toTermination || ''"
            (selectionChange)="updateBulkWires('toTermination', $event.value)">
            <mat-option value="">Mixed / No change</mat-option>
            @for (term of terminationTypes(); track term.value) {
            <mat-option [value]="term.value">{{ term.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </div>
  </mat-expansion-panel>
  }

  @else if (selection()?.type === 'wire') {
  <mat-expansion-panel [expanded]="true" class="wire-panel">
    <mat-expansion-panel-header>
      <mat-panel-title>Wire Properties</mat-panel-title>
    </mat-expansion-panel-header>

    <div class="property-group">
      <div class="connection-info">
        <div class="endpoint">
          <strong>From:</strong>
          {{ getEndpointDescription(selection()?.connection, 'from') }}
        </div>
        <mat-icon class="arrow-icon">arrow_forward</mat-icon>
        <div class="endpoint">
          <strong>To:</strong>
          {{ getEndpointDescription(selection()?.connection, 'to') }}
        </div>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Wire Label</mat-label>
        <input matInput [value]="selection()?.connection?.label || ''" (input)="updateConnectionInput('label', $event)"
          placeholder="e.g., IGN, GND, PWR" [disabled]="isLocked()">
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Wire Color</mat-label>
        <mat-select [value]="selection()?.connection?.color || 'BK'"
          (selectionChange)="updateConnection('color', $event.value)" [disabled]="isLocked()">
          @for (color of wireColors; track color.code) {
          <mat-option [value]="color.code">
            <span class="color-option">
              <span class="color-swatch" [style.backgroundColor]="color.hex"></span>
              {{ color.name }} ({{ color.code }})
            </span>
          </mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Wire Gauge</mat-label>
        <mat-select [value]="selection()?.connection?.gauge || ''"
          (selectionChange)="updateConnection('gauge', $event.value)" [disabled]="isLocked()">
          <mat-option value="">Not specified</mat-option>
          @for (gauge of awgGauges; track gauge) {
          <mat-option [value]="gauge">{{ gauge }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Length (mm)</mat-label>
        <input matInput type="number" [value]="selection()?.connection?.lengthMm || ''"
          (input)="updateConnectionInput('lengthMm', $event)" min="1" [disabled]="isLocked()">
      </mat-form-field>

      @if (selection()?.connection?.cable) {
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Wire in Cable</mat-label>
        <mat-select [value]="selection()?.connection?.wire || ''"
          (selectionChange)="updateConnection('wire', $event.value)" [disabled]="isLocked()">
          @for (wire of getWiresForCable(selection()?.connection?.cable); track wire.id) {
          <mat-option [value]="wire.id">
            <span class="color-option">
              <span class="color-swatch" [style.backgroundColor]="getWireHex(wire.colorCode || wire.color)"></span>
              {{ wire.color }}
            </span>
          </mat-option>
          }
        </mat-select>
      </mat-form-field>
      }

      <mat-divider></mat-divider>

      <!-- Wire End Terminations -->
      <div class="termination-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Left End</mat-label>
          <mat-select [value]="selection()?.connection?.fromTermination || ''"
            (selectionChange)="updateConnection('fromTermination', $event.value)" [disabled]="isLocked()">
            <mat-option value="">None</mat-option>
            @for (term of terminationTypes(); track term.value) {
            <mat-option [value]="term.value">{{ term.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Right End</mat-label>
          <mat-select [value]="selection()?.connection?.toTermination || ''"
            (selectionChange)="updateConnection('toTermination', $event.value)" [disabled]="isLocked()">
            <mat-option value="">None</mat-option>
            @for (term of terminationTypes(); track term.value) {
            <mat-option [value]="term.value">{{ term.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </div>
  </mat-expansion-panel>
  }
</div>